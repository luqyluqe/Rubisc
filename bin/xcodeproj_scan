#!/usr/bin/ruby

require File.join(File.dirname(__FILE__), '..', 'lib','fileutil')

unless ARGV[0] and ARGV[1]
    puts "Usage: xcodeproj_scan <path_to_xcodeproj> <project_directory>"
    puts "Example: xcodeproj_scan /Users/rubisc/Proj/Proj.xcodeproj /Users/rubisc/Proj"
    exit
end
unless File.exist? ARGV[0]
    puts "#{ARGV[0]} does not exist."
    puts "Please provide the path to .xcodeproj file."
    exit
end
unless File.exist? ARGV[1]
	puts "#{ARGV[1]} does not exist."
	puts "Please provide the project directory."
end

pbxproj="#{ARGV[0]}/project.pbxproj"
projdir=ARGV[1]

def scan pbx,dir
    if dir!="." and dir!=".." and
        if File.directory?(dir)
            Dir.entries(dir).each do |sub|
                if sub!="." and sub!=".."
                    scan pbx,"#{dir}/#{sub}"
                end
            end
        else
			match =dir.match /\/([^\/]*$)/
            filename=match[1]
			return if ['.DS_Store','Contents.json','project.pbxproj'].include? filename or filename.match /.*\.(xcworkspacedata|xcuserstate|xcscheme|xcbkptlist|md)/
			puts "#{filename} not used" unless pbx.match filename
        end
    end
end

Rubisc::FileUtil::process_file pbxproj,false do |content|
	scan content,projdir
end
